```{r include=FALSE}
library(tidyverse)
library(tidymodels)
library(nortest)
library(lubridate)
library(ggcorrplot)
library(Factoshiny)
library(FactoMineR)
library(factoextra)
library(arules)
library(RColorBrewer)
library(viridis)
library(tidytext)
library(moments)
library(ggrepel)
options(ggrepel.max.overlaps = Inf)
```

Read data

```{r}
df <- read_csv("df_preprocessed.csv")

numeric_cols <- df %>%
  select_if(is.numeric)

cols_zero_var <- numeric_cols %>% 
  select(colnames(numeric_cols)[1:2],
         colnames(numeric_cols)[12:13],
         colnames(numeric_cols)[32:ncol(numeric_cols)],
         -TotalKg)



num_to_cat <- cols_zero_var %>%
  transmute(
    Age_class = ifelse(
      Age < 12, "Kid", ifelse(
      Age < 18, "Teenager", ifelse(
      Age < 40, "Regular", "Veteran"))),
    BodyWeight_class = ifelse(
      BodyweightKg < 61, "61", ifelse(
      BodyweightKg < 67, "67", ifelse(
      BodyweightKg < 73, "73", ifelse(
      BodyweightKg < 81, "81", ifelse(
      BodyweightKg < 96, "96", ifelse(
      BodyweightKg < 109, "109", ifelse(
      BodyweightKg < 10000, "109+", "Error"
    )))))))) %>%
  mutate(Age_class = as_factor(Age_class),
         BodyWeight_class = as_factor(BodyWeight_class))
```

-   Correlation plot

```{r}
round(cor(cols_zero_var, use = "complete.obs"), 1) %>%
  ggcorrplot()
```

Makes sense

```{r}
data_long <- cols_zero_var %>%                          # Apply pivot_longer function
  pivot_longer(colnames(cols_zero_var)) %>% 
  as.data.frame()

ggplot(data_long, aes(x = value)) +    # Draw histogram & density
  geom_histogram(aes(y = ..density..)) + 
  geom_density(col = "#1b98e0", size = .5) + 
  facet_wrap(~ name, scales = "free")




univariate_vals <- data_long %>%
  group_by(name) %>%
  summarize(kurtosis = kurtosis(value),
            skewness = skewness(value),
            mean = mean(value),
            median = median(value),
            sd = sd(value),
            Q1 = quantile(value, probs = 0.25),
            Q3 = quantile(value, probs = 0.25),
            max = max(value),
            min = min(value))

univariate_vals_long <- univariate_vals %>%
  pivot_longer(!name, names_to = "metric") %>% 
  as.data.frame()

univariate_vals_long %>% 
  ggplot(aes(x = name, y = value)) + geom_col() + 
  facet_wrap(~metric, scales = "free") + coord_flip() 



ad.test(cols_zero_var$Goodlift)
```



-   PCA

```{r}
pca_rec <- recipe(~., data = cols_zero_var) %>% 
  step_normalize(all_predictors()) %>%
  step_pca(all_predictors()) 

pca_prep <- prep(pca_rec)

tidied_pca <- tidy(pca_prep, 2)

tidied_pca %>%
  filter(component %in% paste0("PC", 1:9)) %>%
  mutate(component = fct_inorder(component)) %>%
  ggplot(aes(value, terms, fill = terms)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~component, nrow = 1) +
  labs(y = NULL)

summary(pca_prep$steps[[2]]$res)

juice(pca_prep) %>%
  ggplot(aes(PC1, PC2)) +
  geom_point(alpha = 0.7, size = 2) +
  labs(color = NULL)

pca_cumm <- as_tibble(summary(pca_prep$steps[[2]]$res)$importance)[3, ] %>%
  gather()

pca_cumm %>%
  mutate(key = fct_inorder(key)) %>%
  filter(key %in% paste0("PC", 1:10)) %>%
  ggplot(aes(x = key, y = value)) + geom_col(fill = "#91E5F8") 
```

With factoextra

```{r}
res.pca <- PCA(cols_zero_var, graph = FALSE)
eig <- get_eig(res.pca)
eig
fviz_screeplot(res.pca, addlabels = TRUE, ylim = c(0, 50))
var <- get_pca_var(res.pca)
var

fviz_pca_var(res.pca, col.var="contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE # Avoid text overlapping
             )

# Contributions of variables to PC1
fviz_contrib(res.pca, choice = "var", axes = 1, top = 10)
# Contributions of variables to PC2
fviz_contrib(res.pca, choice = "var", axes = 2, top = 10)
fviz_pca_ind(res.pca,
             label = "none", # hide individual labels
             habillage = as_factor(df$Sex), # color by groups
             palette = c("#00AFBB", "#E7B800", "#FC4E07"),
             addEllipses = TRUE, # Concentration ellipses
             alpha.ind = 0.3
             )
```

-   Multiple Correspondence Analysis

```{r}
df_mca <- df %>%
  mutate(across(ends_with("?"), ~factor(.x, labels = c("Not lifted", "Lifted")))) %>%
  select(Sex, Equipment, Tested, Place, ends_with("?")) %>%
  mutate(across(1:6, ~factor(.x))) %>%
  cbind(num_to_cat)
#%>% sample_n(1000)


df_mca$Age_class <- factor(df_mca$Age_class, levels = c('Kid', 'Teenager', 'Regular', 'Veteran'), ordered = TRUE)
df_mca$BodyWeight_class <- factor(df_mca$BodyWeight_class, levels = c('61', '67', '73', '81', '96', '109', '109+'), ordered = TRUE)
df_mca$Place<- factor(df_mca$Place, levels = c("DQ","Other","10","9","8","7","6","5","4","3","2","1"), ordered = TRUE)
df_mca$DeadliftInc1_class<- factor(df_mca$DeadliftInc1_class, levels = c('Small','Median','Big'), ordered = TRUE)
df_mca$DeadliftInc2_class<- factor(df_mca$DeadliftInc2_class, levels = c('Small','Median','Big'), ordered = TRUE)
df_mca$SquatInc1_class<- factor(df_mca$SquatInc1_class, levels = c('Small','Median','Big'), ordered = TRUE)
df_mca$SquatInc2_class<- factor(df_mca$SquatInc2_class, levels = c('Small','Median','Big'), ordered = TRUE)
df_mca$BenchInc1_class<- factor(df_mca$BenchInc1_class, levels = c('Small','Median','Big'), ordered = TRUE)
df_mca$BenchInc2_class<- factor(df_mca$BenchInc2_class, levels = c('Small','Median','Big'), ordered = TRUE)




#result <- Factoshiny(df_mca)


res.MCA <- MCA(df_mca,graph=FALSE)

#variables

colors = palette.colors(ncol(df_mca),palette='Polychrome 36')
colorsvar = colorsvar=rep(colors, times = c(2,3,2,12,2,2,2,2,2,2,2,2,2,4,7,3,3,3,3,3,3))
plot.MCA(res.MCA, invisible='ind',label='var', axes=c(1,2), col.var = colorsvar,autoLab = 'yes', cex = .8)#AFEGIR LEGEND



#contributions
fviz_contrib(res.MCA, choice = "var", axes = 1,top= 15)


plot.MCA(res.MCA, choix='var',axes=c(1,2),repel=TRUE, ggtheme = theme.minimal())

#fviz_mca_var(res.MCA, choice = "var", axes=c(1,2), repel = TRUE, ggtheme = theme_minimal())
#el de sobre no funciona bÃ©


#plot.MCA(res.MCA, choix='ind',label='var')
#individuals
plot.MCA(res.MCA, choix='ind',invisble = 'var',label='none', axes = c(1,2), habillage =1, autoLab = 'yes',res=300)#,cex=.6)

fviz_mca_ind(res.MCA, axes= c(1,2), geom.ind = 'point', alpha.ind=.1)

# plot.MCA(res.MCA,invisible= 'ind',selectMod= 'cos2 0.2',label =c('var'), graph.type="ggplot") + 
#   geom_text_repel() + ggtitle("Mca factor map with cos2 >= 0.2")

#Values 
summary(res.MCA)

#Description of the axis

#eigenvalues
eigenvalues <- get_eigenvalue(res.MCA)

#measures the degree of association between variable categories and a particular axis
# fviz_mca_var(res.MCA, alpha.var = "cos2", select.var = list(cos2 = 0.15),
#              gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), 
#              repel = TRUE, # Avoid text overlapping
#              ggtheme = theme_minimal())

#visualize the inertia kept by dimensions

fviz_screeplot(res.MCA, addlabels = TRUE, ylim = c(0, 10))

#quality of representation  
# fviz_cos2(res.MCA, choice = "var", axes = 1:2)
```

-   Multiple Factor Analysis

```{r}
df_mfa <- df %>%
  mutate(across(ends_with("?"), ~factor(.x, labels = c("Not lifted", "Lifted")))) %>%
  select(Sex, Equipment, Tested, Federation, Place, ends_with("?"), where(is.numeric)) %>%
  mutate(across(1:5, ~factor(.x))) %>%
  mutate_if(is.numeric, abs) %>%
  cbind(num_to_cat)

#We have to decide groups

# Lifter associated health and condition
# Weight tried
# Quality of the lifts

df_mfa <- df_mfa %>%
  select(Age, BodyweightKg,
         Squat, SquatInc1, SquatInc2, Bench, BenchInc1, 
         BenchInc2, Deadlift, DeadliftInc1, DeadliftInc2,
         ends_with("?"),
         Place)

res.mfa <- MFA(df_mfa, 
               group = c(2, 9, 9, 1), 
               ind.sup = c(4),
               type = c("s", "s", "n", "n"),
               name.group = c("Lifter condition", "Weight tried", "Quality of the lift", "Place"),
               graph = FALSE)

head(get_eigenvalue(res.mfa))

fviz_screeplot(res.mfa)

group_mfa <- get_mfa_var(res.mfa, "group")
fviz_mfa_var(res.mfa, "group")
fviz_contrib(res.mfa, "group", axes = 1)
fviz_contrib(res.mfa, "group", axes = 2)

get_mfa_var(res.mfa, "quanti.var")

fviz_mfa_var(res.mfa, "quanti.var", palette = "jco", 
             col.var.sup = "violet", repel = TRUE,
             geom = c("point", "text"), legend = "bottom")

  

fviz_contrib(res.mfa, choice = "quanti.var", axes = 1, top = 20,
             palette = "jco")
fviz_contrib(res.mfa, choice = "quanti.var", axes = 2, top = 20,
             palette = "jco")

fviz_mfa_var(res.mfa, "quanti.var", col.var = "contrib", 
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), 
             col.var.sup = "violet", repel = TRUE,
             geom = c("point", "text"))


fviz_mfa_var(res.mfa, col.var = "cos2",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), 
             col.var.sup = "violet", repel = TRUE, geom = c("point", "text"))

fviz_cos2(res.mfa, choice = "quanti.var", axes = 1)

#The graph of partial axes shows the relationship between the principal axes 
#of the MFA and the ones obtained from analyzing each group using either a PCA 
#(for groups of continuous variables) or a MCA (for qualitative variables).

fviz_mfa_axes(res.mfa, geom = c("point", "text"), graph.type="ggplot", repel = T)

fviz_mfa_axes(res.mfa, repel = T)


######Association Rules######

itemFrequencyPlot(transactions(df_mca), topN = 20,
                  col = brewer.pal(8, 'BuPu'),
                  main = 'Relative Item Frequency Plot',
                  type = "relative",
                  ylab = "Item Frequency (Relative)")
```


## MFA

-   Lifter attributes
    -   "Country", "Sex"
    -   "Age", "BodyweightKg"
-   Lifter equipment
    -   "Equipment"
-   Lifter results
    -   "Squat1Kg", "Squat2Kg", "Squat3Kg"
    -   "Bench1Kg", "Bench2Kg", "Bench3Kg"
    -   "Deadlift1Kg", "Deadlift2Kg", "Deadlift3Kg"
    -   "TotalKg"
    -   "Goodlift"
    -   "WeightTriedSquat1Kg", "WeightTriedSquat2Kg", "WeightTriedSquat3Kg",
    -   "WeightTriedBench1Kg", "WeightTriedBench2Kg", "WeightTriedBench3Kg"
    -   "WeightTriedDeadlift1Kg", "WeightTriedDeadlift2Kg", "WeightTriedDeadlift3Kg"
    -   "LiftedSquat1Kg?", "LiftedSquat2Kg?", "LiftedSquat3Kg?"
    -   "LiftedBench1Kg?", "LiftedBench2Kg?", "LiftedBench3Kg?"
    -   "LiftedDeadlift1Kg?", "LiftedDeadlift2Kg?", "LiftedDeadlift3Kg?"
    -   "Squat", "SquatInc1", "SquatInc2"
    -   "Bench", "BenchInc1", "BenchInc2"
    -   "Deadlift", "DeadliftInc1", "DeadliftInc2"
    -   "Place"
-   Competition
    -   "Event", "Federation", "MeetName", "MeetCountry", "Tested"
    -   "Date"

```{r}
df_mfa <- df

# Date to numeric
df_mfa$Date <- as.numeric(format(as.Date(df_mfa$Date), "%Y%m%d"))

# Preparation
df_mfa <- df_mfa %>%
  mutate(across(ends_with("?"), ~factor(.x, labels = c("Not lifted", "Lifted")))) %>%
  select(Sex, Equipment, Tested, Federation, Place, Country, ends_with("?"), where(is.numeric)) %>%
  mutate(across(1:6, ~factor(.x))) %>%
  mutate_if(is.numeric, abs) %>%
  cbind(num_to_cat)

# Ordered Place
df_mfa$Place <- factor(df_mfa$Place, order = TRUE, levels=c(1:10, "Other", "DQ"))

# Country transform to top 10 and Other
top_10_names <- names(sort(table(df_mfa$Country), decreasing = T)[1:10])
levels(df_mfa$Country) <- c(levels(df_mfa$Country), "Other")
df_mfa[!(df_mfa$Country %in% top_10_names),]$Country <- "Other"
df_mfa$Country <- droplevels(df_mfa$Country)
```

```{r}
# MFA
groups <- list(
  # "Lifter attributes"=list("n", c("Sex", "Age_class", "BodyWeight_class")),
  # "Lifter attributes"=list("n", c("Sex", "Country")),
  "Lifter attributes"=list("n", c("Sex")),
  "Lifter condition"=list("s", c("Age", "BodyweightKg")),
  #"Lifter equipment"=list("n", c("Equipment")),
  "Lift tried"=list("s", c("Squat", "SquatInc1", "SquatInc2",
                           "Bench", "BenchInc1", "BenchInc2",
                           "Deadlift", "DeadliftInc1", "DeadliftInc2")),
  "Lift quality"=list("n", c("LiftedSquat1Kg?", "LiftedSquat2Kg?", "LiftedSquat3Kg?",
                             "LiftedBench1Kg?", "LiftedBench2Kg?", "LiftedBench3Kg?",
                             "LiftedDeadlift1Kg?", "LiftedDeadlift2Kg?", "LiftedDeadlift3Kg?")),
  # Only using attempts 1 and 2
  # "Lift tried"=list("s", c("Squat", "SquatInc1",
  #                          "Bench", "BenchInc1",
  #                          "Deadlift", "DeadliftInc1")),
  # "Lift quality"=list("n", c("LiftedSquat1Kg?", "LiftedSquat2Kg?",
  #                            "LiftedBench1Kg?", "LiftedBench2Kg?",
  #                            "LiftedDeadlift1Kg?", "LiftedDeadlift2Kg?")),
  # Only using attempt 1
  # "Lift tried"=list("s", c("Squat", "Bench", "Deadlift")),
  # "Lift quality"=list("n", c("LiftedSquat1Kg?", "LiftedBench1Kg?", "LiftedDeadlift1Kg?")),
  # "Competition"=list("n", c("Federation", "Tested")),
  # "Date"=list("s", c("Date")),
  "Place"=list("n", c("Place")))

group_nums <- unname(sapply(groups, function(g) length(unlist(g[2]))))
group_types <- unname(sapply(groups, function(g) unlist(g[1])))
group_vars <- unname(unlist(sapply(groups, function(g) unlist(g[2]))))
group_names <- names(groups)

df_mfa <- df_mfa[, group_vars]

res.mfa <- MFA(df_mfa,
               group = group_nums,
               type = group_types,
               name.group = group_names,
               num.group.sup = c(1),
               graph = FALSE)

head(get_eigenvalue(res.mfa), 20)
res.mfa$inertia.ratio
fviz_screeplot(res.mfa)
```

```{r}
fviz_contrib(res.mfa, "group", axes = 1)
fviz_contrib(res.mfa, "group", axes = 2)
fviz_contrib(res.mfa, "group", axes = 3)
fviz_contrib(res.mfa, "group", axes = 4)
```


```{r}
grad_col <- c("#00AFBB", "#E7B800", "#FC4E07")
```


```{r}
#dimdesc(res.mfa, axes = 1:2)

fviz_mfa_var(
  res.mfa, choice = "group", axes = c(1, 2),
  col.var = "contrib", gradient.cols = grad_col)
fviz_mfa_var(
  res.mfa, choice = "group", axes = c(2, 3),
  col.var = "contrib", gradient.cols = grad_col)
fviz_mfa_var(
  res.mfa, choice = "group", axes = c(3, 4),
  col.var = "contrib", gradient.cols = grad_col)
```

```{r}
fviz_contrib(res.mfa, choice = "quanti.var", axes = 1, top = 10)
fviz_contrib(res.mfa, choice = "quali.var", axes = 1, top = 10)
fviz_contrib(res.mfa, choice = "quanti.var", axes = 2, top = 10)
fviz_contrib(res.mfa, choice = "quali.var", axes = 2, top = 10)
fviz_contrib(res.mfa, choice = "quanti.var", axes = 3, top = 10)
fviz_contrib(res.mfa, choice = "quali.var", axes = 3, top = 10)
fviz_contrib(res.mfa, choice = "quanti.var", axes = 4, top = 10)
fviz_contrib(res.mfa, choice = "quali.var", axes = 4, top = 10)
```

```{r}
axes <- c(1, 2)
fviz_mfa_var(res.mfa, "quanti.var", axes = axes,
             select.var = list(cos2 = 20),
             col.var = "contrib", gradient.cols = grad_col, repel = TRUE)
fviz_mfa_var(res.mfa, "quali.var", axes = axes,
             select.var = list(cos2 = 20),
             col.var = "contrib", gradient.cols = grad_col, repel = TRUE)
axes <- c(2, 3)
fviz_mfa_var(res.mfa, "quanti.var", axes = axes,
             select.var = list(cos2 = 20),
             col.var = "contrib", gradient.cols = grad_col, repel = TRUE)
fviz_mfa_var(res.mfa, "quali.var", axes = axes,
             select.var = list(cos2 = 20),
             col.var = "contrib", gradient.cols = grad_col, repel = TRUE)
axes <- c(3, 4)
fviz_mfa_var(res.mfa, "quanti.var", axes = axes,
             select.var = list(cos2 = 20),
             col.var = "contrib", gradient.cols = grad_col, repel = TRUE)
fviz_mfa_var(res.mfa, "quali.var", axes = axes,
             select.var = list(cos2 = 20),
             col.var = "contrib", gradient.cols = grad_col, repel = TRUE)
```

```{r}
fviz_mfa_axes(res.mfa, axes = c(2, 3), repel=T)
```

```{r}
fviz_mfa_ind(
  res.mfa,
  axes = c(1, 2),
  habillage = "Place",
  addEllipses = TRUE,
  geom = c("point"),
  col.ind = "black",
  alpha.ind = 0.3,
  repel = T)
fviz_mfa_ind(
  res.mfa,
  axes = c(2, 3),
  habillage = "Place",
  addEllipses = TRUE,
  geom = c("point"),
  col.ind = "black",
  alpha.ind = 0.3,
  repel = T)
fviz_mfa_ind(
  res.mfa,
  axes = c(2, 4),
  habillage = "Place",
  addEllipses = TRUE,
  geom = c("point"),
  col.ind = "black",
  alpha.ind = 0.3,
  repel = T)
```


```{r}
# Check individual summaries for a range in a particular dimension
val <- 2.2
cond <- res.mfa$ind$coord[,3] > val-0.2 & res.mfa$ind$coord[,3] < val+0.2
summary(df_mfa[rownames(res.mfa$ind$coord)[cond],])
```


```{r}
ds <- c(3, 2)

fviz_mfa_ind(
  res.mfa,
  axes = ds,
  habillage = "LiftedSquat1Kg?",
  addEllipses = T,
  geom = c("point"),
  col.ind = "black",
  pointsize = 1,
  alpha.ind = 0.3,
  repel = T)
fviz_mfa_ind(
  res.mfa,
  axes = ds,
  habillage = "LiftedBench1Kg?",
  addEllipses = T,
  geom = c("point"),
  col.ind = "black",
  pointsize = 1,
  alpha.ind = 0.3,
  repel = T)
fviz_mfa_ind(
  res.mfa,
  axes = ds,
  habillage = "LiftedDeadlift1Kg?",
  addEllipses = T,
  geom = c("point"),
  col.ind = "black",
  pointsize = 1,
  alpha.ind = 0.3,
  repel = T)
```

```{r}
ds <- c(3, 2)

fviz_mfa_ind(
  res.mfa,
  axes = ds,
  habillage = "LiftedSquat1Kg?",
  addEllipses = T,
  geom = c("point"),
  col.ind = "black",
  pointsize = 1,
  alpha.ind = 0.3,
  repel = T)
fviz_mfa_ind(
  res.mfa,
  axes = ds,
  habillage = "LiftedSquat2Kg?",
  addEllipses = T,
  geom = c("point"),
  col.ind = "black",
  pointsize = 1,
  alpha.ind = 0.3,
  repel = T)
fviz_mfa_ind(
  res.mfa,
  axes = ds,
  habillage = "LiftedSquat3Kg?",
  addEllipses = T,
  geom = c("point"),
  col.ind = "black",
  pointsize = 1,
  alpha.ind = 0.3,
  repel = T)
```


```{r}
# Check individuals projections to a combined vector

dir <- (
  res.mfa$quali.var$coord["LiftedSquat1Kg?_Not lifted",] +
  res.mfa$quali.var$coord["LiftedBench1Kg?_Not lifted",] +
  res.mfa$quali.var$coord["LiftedDeadlift1Kg?_Not lifted",] +
  res.mfa$quali.var$coord["LiftedSquat2Kg?_Not lifted",] +
  res.mfa$quali.var$coord["LiftedBench2Kg?_Not lifted",] +
  res.mfa$quali.var$coord["LiftedDeadlift2Kg?_Not lifted",] +
  res.mfa$quali.var$coord["LiftedSquat3Kg?_Not lifted",] +
  res.mfa$quali.var$coord["LiftedBench3Kg?_Not lifted",] +
  res.mfa$quali.var$coord["LiftedDeadlift3Kg?_Not lifted",]
)

dir <- dir / sqrt(sum(dir^2))

proj <- res.mfa$ind$coord %*% dir

summary(df_mfa[rownames(res.mfa$ind$coord)[proj > -5 & proj <= 0.1],])
```


```{r}
fviz_ellipses(res.mfa,
              axes = c(1, 2),
              c("LiftedSquat1Kg?", "LiftedBench1Kg?", "LiftedDeadlift1Kg?"),
              geom = c("point"),
              repel = TRUE)
fviz_ellipses(res.mfa,
              axes = c(2, 4),
              c("LiftedSquat1Kg?", "LiftedBench1Kg?", "LiftedDeadlift1Kg?"),
              geom = c("point"),
              repel = TRUE)
```


```{r}
library(plot3D)
library(plot3Drgl)

set.seed(0)

ds <- c(2, 3, 4)

# Individuals (sample ~10%)
smpl <- sample(rownames(res.mfa$ind$coord), 30000)
px <- res.mfa$ind$coord[smpl,ds[1]]
py <- res.mfa$ind$coord[smpl,ds[2]]
pz <- res.mfa$ind$coord[smpl,ds[3]]
scatter3D(px, py, pz, colvar = proj[smpl,], pch = 20, cex = 0.5, bty = "n")

# Variables
zeros <- rep(0, nrow(res.mfa$quali.var$coord))
ax <- res.mfa$quali.var$coord[,ds[1]]
ay <- res.mfa$quali.var$coord[,ds[2]]
az <- res.mfa$quali.var$coord[,ds[3]]
arrows3D(zeros, zeros, zeros, ax, ay, az, add=T, bty = "n")
text3D(ax, ay, az, rownames(res.mfa$quali.var$coord), add=T, bty = "n")

plotrgl()
```

```{r}
fviz_mfa_ind(res.mfa, partial = c("1", "2", "3"), geom = c("point"), alpha.ind = 0.3)
```


-   Association Rules

    Hyperparameters:

    -   Support: threshold (frequency of the minimum count) number of appareances / number of entries number of app. of a set / number of sets: item set A and B presents (P(A u B)) / total number of transactions // ojo, es and

        Min support ideas for the hyperparameter

    -   Confidence:

        -   close to 1 if possible

Eclat same as apriori but changing horizontal layout to vertical (long to wide format)

support: confidence: lift: kpi, correlation and independence between elements into the rule l ift(a,b) = conf(a,b) / sup(b) = p(AuB) / P(A) \* P(B) if a,b independent, p(AuB) = p(A)\*p(B) if lift \> 1, strongstrong if lift = 1, independent elements else not coverage: kpi

```{r}

#https://www.datarlabs.com/post/market-basket-optimisation-using-association-rule-mining

df_eclat <- transactions(df_mca)

rules_eclat = eclat(data = df_eclat, 
              parameter = list(support = 0.8,  minlen = 2))


inspect(sort(rules_eclat, by = 'support')[1:10])

#Tested -> may imply better tournament so better lifters
```

-   Apriori

```{r}


df_apriori <- transactions(df_mca)

rules_apriori <- apriori(df_apriori, parameter = list(supp = 0.8, conf = 0.8)) #, minlen = 2))

inspect(rules_apriori[1:20])

#Quick check
# df_mca %>% select(contains("1")) %>% group_by(`LiftedSquat1Kg?`) %>% summarize(n = n())
# df_mca %>% select(contains("1")) %>% group_by(`LiftedBench1Kg?`) %>% summarize(n = n())
# df_mca %>% select(contains("1")) %>% group_by(`LiftedDeadlift1Kg?`) %>% summarize(n = n())
# df_mca %>% select(contains("2")) %>% group_by(`LiftedSquat2Kg?`) %>% summarize(n = n())
# df_mca %>% select(contains("2")) %>% group_by(`LiftedBench2Kg?`) %>% summarize(n = n())
# df_mca %>% select(contains("2")) %>% group_by(`LiftedDeadlift2Kg?`) %>% summarize(n = n())
# df_mca %>% select(contains("3")) %>% group_by(`LiftedSquat3Kg?`) %>% summarize(n = n())
# df_mca %>% select(contains("3")) %>% group_by(`LiftedBench3Kg?`) %>% summarize(n = n())
# df_mca %>% select(contains("3")) %>% group_by(`LiftedDeadlift3Kg?`) %>% summarize(n = n())

```

-   Swag plots

```{r}
df %>%
  ggplot(aes(x = TotalKg, fill = Sex)) + geom_boxplot() + 
  facet_wrap(~Sex) + scale_fill_viridis_d() 


df %>%
  filter(!is.na(Country)) %>%
  ggplot(aes(x = TotalKg, fill = Country)) + 
  geom_boxplot(show.legend = F) + 
  facet_wrap(~Country) +
  scale_fill_viridis_d() 


df %>%
  group_by(Date) %>%
  summarize(m = median(TotalKg)) %>%
  ggplot(aes(x = Date, y = m)) + geom_point() + geom_smooth()


df %>%
  group_by(Tested) %>%
  summarize(n = n()) %>%
  ggplot(aes(x = Tested, y = n)) + geom_col()

round(cor(numeric_cols, use = "complete.obs"), 1) %>%
  ggcorrplot(ggtheme = ggplot2::theme_gray,
             colors = c("#6D9EC1", "white", "#E46726"),
             lab = T, type = "lower")



##World map over total df
world <- map_data("world")


world %>%
  merge(df %>%
          group_by(Country) %>%
          summarize(n = mean(TotalKg, na.rm = T)) %>%
          mutate(country = Country), 
        by.x = "region", by.y = "country", all.x = T) %>%
  arrange(group, order) %>%
  ggplot(aes(x = long, y = lat, group = group, fill = n)) + 
  geom_polygon(color = "white", size = 0.2) +
  scale_fill_viridis(option="mako", na.value = "gray90") +
  theme_minimal() +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        panel.grid = element_blank()) + 
  ggtitle("Mean KG lifted by country")


world %>%
  merge(df %>%
          group_by(Country) %>%
          summarize(n = mean(Age, na.rm = T)) %>%
          mutate(country = Country), 
        by.x = "region", by.y = "country", all.x = T) %>%
  arrange(group, order) %>%
  ggplot(aes(x = long, y = lat, group = group, fill = n)) + 
  geom_polygon(color = "white", size = 0.2) +
  scale_fill_viridis(option="mako", na.value = "gray90") +
  theme_minimal() +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        panel.grid = element_blank()) + 
  ggtitle("Mean Age by country")

```


```{r}
univariate_vals_long_cat <- df_mca %>%
  pivot_longer(colnames(df_mca), names_to = "name") %>% 
  as.data.frame()


univariate_vals_long_cat %>% 
  group_by(name, value) %>%
  summarize(n = n()) %>%
  top_n(15, n) %>%
  mutate(value = reorder_within(value, n, name)) %>%
  ggplot(aes(x = value, y = n)) + geom_col() +
  facet_wrap(~name, scale = "free") + coord_flip()

```

